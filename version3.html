<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Markdown → PDF (client-side)</title>

  <!-- EasyMDE CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">

  <style>
    :root{--accent:#2b8aef;--bg:#f7f9fb}
    body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;margin:0;background:var(--bg);color:#111}
    header{display:flex;gap:1rem;align-items:center;padding:1rem;background:#fff;border-bottom:1px solid #eee}
    header h1{font-size:1.05rem;margin:0}
    .container{display:grid;grid-template-columns:1fr 1fr;gap:1rem;padding:1rem;align-items:start}
    .controls{display:flex;color:black;gap:.5rem;flex-wrap:wrap}
    button{background:var(--accent);color:white;border:0;padding:.55rem .7rem;border-radius:6px;cursor:pointer;font-weight:600}
    button.ghost{background:transparent;color:var(--accent);border:1px solid #d9e7ff}
    .panel{background:#fff;border-radius:8px;padding:1rem;box-shadow:0 6px 18px rgba(20,30,60,0.04)}
    .panel h2{margin-top:0;font-size:.95rem}
    #preview{padding:1rem;max-height:60vh;overflow:auto;border:1px solid #f0f0f0;border-radius:6px;background:#fff}
    .top-controls{display:flex;color:black;gap:.5rem;align-items:center}
    input[type=file]{display:none}
    .small{padding:.35rem .5rem;font-size:.9rem}
    footer{padding:1rem;text-align:center;color:#666;font-size:.9rem}
    .print-area h1, 
.print-area h2,
.print-area h3 { page-break-after: avoid; }

.print-area pre,
.print-area table,
.print-area blockquote {
  page-break-inside: avoid;
}

.print-area img {
  max-width: 100%;
}
    @media (max-width:900px){.container{grid-template-columns:1fr}}

    /* === EasyMDE toolbar text labels / visible buttons (no icons) === */
    .editor-toolbar { gap:6px; }
    .editor-toolbar button {
      color: #000 !important;
      background: transparent !important;
      border: 1px solid transparent;
      min-width: 42px;
      padding: 6px 8px;
      font-weight: 700;
      border-radius: 6px;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .editor-toolbar button:hover { background: #f0f4fb; border-color: #e0e9ff; }

    /* text labels for toolbar (before pseudo elements) */
    .tb-bold::before        { content: "B"; }
    .tb-italic::before      { content: "I"; font-style: italic; }
    .tb-heading::before     { content: "H"; }
    .tb-quote::before       { content: "»"; }
    .tb-ul::before          { content: "•"; }
    .tb-ol::before          { content: "1."; }
    .tb-code::before        { content: "</>"; }
    .tb-link::before        { content: "Link"; font-weight:600; font-size:12px; }
    .tb-image::before       { content: "Img"; font-weight:600; font-size:12px; }
    .tb-preview::before     { content: "Preview"; font-weight:600; font-size:12px; }
    .tb-sbs::before         { content: "Side"; font-weight:600; font-size:12px; }
    .tb-full::before        { content: "Full"; font-weight:600; font-size:12px; }

    /* Markdown-preview print-friendly styles (used when exporting PDF) */
    .printable {
      background: #fff;
      color: #111;
      padding: 24px;
      box-sizing: border-box;
      width: 794px; /* A4 width at 96dpi ~ 794px */
      margin: 0 auto;
      font-family: Arial, Helvetica, sans-serif;
      font-size: 13px;
      line-height: 1.5;
    }
    .printable h1,.printable h2,.printable h3{page-break-after:avoid}
    .printable pre { background:#f6f8fa;padding:12px;border-radius:6px;overflow:auto;white-space:pre-wrap;word-wrap:break-word }
    .printable code { background:#f6f8fa;padding:2px 4px;border-radius:4px }
    .printable table { border-collapse: collapse; width:100%; margin: 8px 0; }
    .printable table th, .printable table td { border:1px solid #ddd; padding:8px; text-align:left; }
    .printable img { max-width:100%; height:auto; }
    /* Make sure large blocks avoid breaking across pages awkwardly */
    .printable h2, .printable h3, .printable pre, .printable table, .printable blockquote {
      page-break-inside: avoid;
      break-inside: avoid;
    }
    /* page break utility: insert `---PAGE-BREAK---` to force new page */
    .page-break { page-break-before: always; break-before: page; height:1px; }
  </style>
</head>
<body>

<header>
  <h1>Smart Markdown → PDF</h1>
  <div style="flex:1"></div>
  <div class="controls">
    <button id="btnAutoPaste" title="Read text from clipboard (requires permission)">Auto-paste</button>
    <label for="fileTxt" class="ghost small" style="cursor:pointer;padding:.4rem .6rem;border-radius:6px;border:1px solid #ddd;">Upload .txt</label>
    <input id="fileTxt" type="file" accept=".txt,text/plain" />
    <button id="btnSuggest" class="small ghost">Smart Suggest</button>
    <button id="btnReset" class="small ghost">Reset</button>
  </div>
</header>

<div class="container">
  <div class="panel">
    <h2>Editor</h2>
    <textarea style="max-height:70vh;color:#111" id="editorTextarea" placeholder="Paste ChatGPT output here..."></textarea>

    <div style="margin-top:.7rem;display:flex;gap:.5rem;align-items:center">
      <button id="btnDownloadMD" class="small">Download .md</button>
      <button id="btnDownloadPDF" class="small">Download .pdf</button>
      <button id="btnCopyMD" class="small ghost">Copy Markdown</button>
      <div style="flex:1"></div>
      <span style="color:#666;font-size:.9rem">Tip: run <strong>Smart Suggest</strong> then edit.</span>
    </div>
  </div>

  <div class="panel">
    <h2>Live Preview</h2>
    <div id="preview" aria-live="polite"></div>
  </div>
</div>

<footer>
  Runs fully in your browser — no server. Smart-suggest is heuristic and may need editing.
</footer>

<!-- Libraries (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<script>
/* ---------- Init EasyMDE with text-only toolbar (no fontawesome) ---------- */
const easyMDE = new EasyMDE({
  element: document.getElementById('editorTextarea'),
  autofocus: false,
  spellChecker: false,
  status: false,
  minHeight: "36vh",
  toolbar: [
    { name: "bold",     action: EasyMDE.toggleBold,            className: "tb-bold",   title: "Bold" },
    { name: "italic",   action: EasyMDE.toggleItalic,          className: "tb-italic", title: "Italic" },
    { name: "heading",  action: EasyMDE.toggleHeadingSmaller,  className: "tb-heading",title: "Heading" },
    "|",
    { name: "quote",    action: EasyMDE.toggleBlockquote,      className: "tb-quote",  title: "Quote" },
    { name: "unordered",action: EasyMDE.toggleUnorderedList,   className: "tb-ul",     title: "Bullet List" },
    { name: "ordered",  action: EasyMDE.toggleOrderedList,     className: "tb-ol",     title: "Number List" },
    { name: "code",     action: EasyMDE.toggleCodeBlock,       className: "tb-code",   title: "Code Block" },
    { name: "link",     action: EasyMDE.drawLink,              className: "tb-link",   title: "Insert Link" },
    { name: "image",    action: EasyMDE.drawImage,             className: "tb-image",  title: "Insert Image" },
    "|",
    { name: "preview",  action: EasyMDE.togglePreview,         className: "tb-preview",title: "Preview" },
    { name: "side-by-side", action: EasyMDE.toggleSideBySide,  className: "tb-sbs",    title: "Side by Side" },
    { name: "fullscreen",   action: EasyMDE.toggleFullScreen,  className: "tb-full",   title: "Fullscreen" }
  ]
});

/* ---------- Preview rendering ---------- */
const preview = document.getElementById('preview');
function renderPreview(md){
  // Convert markdown to HTML using marked
  preview.innerHTML = marked.parse(md || "");
}

/* sync editor -> preview */
easyMDE.codemirror.on("change", () => {
  renderPreview(easyMDE.value());
});

/* initial render */
renderPreview(easyMDE.value());

/* ---------- Smart Suggest: transform plain ChatGPT-ish text into markdown ---------- */
/* This is based on your previous transformer, improved and kept compact. */
function smartSuggestTransform(raw){
  if(!raw) return "";
  raw = raw.replace(/\r\n/g,"\n").replace(/\t/g,"    ").trim();
  const lines = raw.split("\n");
  const out = [];
  let i = 0;

  const isBlank = s => !s || s.trim()==="";
  const startsWithEmoji = s => /^[\p{Emoji}\u2600-\u27BF]/u.test(s.trim());
  const looksLikeCodeLine = s => /[{;}=>\(\)\[\]]/.test(s) || /\b(function|const|let|var|int|float|double|return|for|while|class|def|import|#include|console\.log)\b/.test(s) || /^\s{2,}/.test(s);
  const isTableRow = s => /\|/.test(s) || (/\t/.test(s) && s.split(/\t/).length>1);
  const isSeparatorLine = s => /^-{3,}\s*$/.test(s) || /^\*\*\*+\s*$/.test(s);

  const flushAsCode = (block) => {
    if(block.length===0) return;
    // minimal language detection
    const lang = block.some(l=>/\b(class|#include|std::|cout|cin|int|float|double)\b/.test(l)) ? "cpp" : "";
    out.push("```" + lang);
    out.push(...block);
    out.push("```");
  };

  while(i < lines.length){
    const L = lines[i];

    // separators/horizontal rules
    if(isSeparatorLine(L) || /^\s*---\s*$/.test(L)){
      out.push("");
      out.push("---");
      out.push("");
      i++; continue;
    }

    if(isBlank(L)){
      out.push("");
      i++; continue;
    }

    // tables (pipe or tab separated)
    if(isTableRow(L)){
      const block = [];
      while(i < lines.length && (isTableRow(lines[i]) || isBlank(lines[i]))){
        if(!isBlank(lines[i])) block.push(lines[i].trim());
        i++;
      }
      // normalize tab-separated to pipes
      const rows = block.map(r => r.includes("|") ? r : ("| " + r.split(/\t+/).map(c=>c.trim()).join(" | ") + " |"));
      // ensure header separator
      if(rows.length >= 2 && !/^\|\s*[:-]/.test(rows[1])){
        const headers = rows[0].split("|").filter(Boolean).map(h=>h.trim());
        const sep = "| " + headers.map(()=> "---").join(" | ") + " |";
        out.push(rows[0]);
        out.push(sep);
        for(let r=1;r<rows.length;r++) out.push(rows[r]);
      } else {
        out.push(...rows);
      }
      out.push("");
      continue;
    }

    const trimmed = L.trim();

    // emoji-heading
    if(startsWithEmoji(trimmed)){
      const t = trimmed.replace(/^[\p{Emoji}\u2600-\u27BF]+\s*/u,"").trim();
      out.push("## " + t);
      i++; continue;
    }

    // numbered short lines as headings
    if(/^\d+\.\s+[A-Z]/.test(trimmed) && trimmed.length < 120){
      out.push("## " + trimmed.replace(/^\d+\.\s+/,"").trim());
      i++; continue;
    }

    // ALL CAPS short line -> heading
    if(trimmed === trimmed.toUpperCase() && trimmed.length < 100 && trimmed.split(" ").length <= 8){
      out.push("## " + trimmed);
      i++; continue;
    }

    // trailing colon -> subheading
    if(/:\s*$/.test(trimmed) && trimmed.split(/\s+/).length <= 8){
      out.push("### " + trimmed.replace(/:\s*$/,""));
      i++; continue;
    }

    // Example/Examples blocks
    if(/^\s*(Example|Examples|Coding Practice|Practice Questions|Exercise|Solution):?/i.test(trimmed)){
      const heading = trimmed.replace(/:$/,"").trim();
      out.push("### " + heading);
      i++;
      const buff = [];
      while(i < lines.length && !isBlank(lines[i]) && !/^\d+\.\s+[A-Z]/.test(lines[i])){
        buff.push(lines[i]);
        i++;
      }
      if(buff.some(ln => looksLikeCodeLine(ln) || /;/.test(ln))){
        const blocks = buff.join("\n").split(/\n\s*\n/);
        blocks.forEach(b=>{
          if(b.split("\n").some(l => looksLikeCodeLine(l) || /;/.test(l))){
            out.push("```");
            out.push(...b.split("\n"));
            out.push("```");
          } else {
            b.split("\n").forEach(x => out.push("> " + x));
          }
        });
      } else {
        buff.forEach(ln => out.push("> " + ln));
      }
      out.push("");
      continue;
    }

    // lists
    if(/^\s*\d+[\.\)]\s+/.test(L) || /^\s*[-\*\u2022]\s+/.test(L)){
      const listLines = [];
      while(i < lines.length && (/^\s*\d+[\.\)]\s+/.test(lines[i]) || /^\s*[-\*\u2022]\s+/.test(lines[i]) || /^\s{4,}/.test(lines[i]))){
        listLines.push(lines[i].replace(/\u2022/,"-"));
        i++;
      }
      out.push(...listLines.map(s=>s.trim()));
      out.push("");
      continue;
    }

    // code block grouping
    if(looksLikeCodeLine(L)){
      const codeBuf = [];
      while(i < lines.length && (looksLikeCodeLine(lines[i]) || lines[i].trim()==="")){
        if(lines[i].trim() !== "") codeBuf.push(lines[i]);
        i++;
      }
      flushAsCode(codeBuf);
      out.push("");
      continue;
    }

    // summary table like "Structure\tKeyword\tWhen to Use"
    if(/Structure\s+Keyword\s+When to Use/i.test(L)){
      const rows = [];
      while(i < lines.length && !isBlank(lines[i])){
        rows.push(lines[i]);
        i++;
      }
      const parsed = rows.map(r => r.split(/\t+| {2,}/).map(c=>c.trim()).filter(Boolean));
      if(parsed.length){
        const header = parsed[0];
        out.push("| " + header.join(" | ") + " |");
        out.push("| " + header.map(()=> "---").join(" | ") + " |");
        for(let r=1;r<parsed.length;r++) out.push("| " + parsed[r].join(" | ") + " |");
        out.push("");
      }
      continue;
    }

    // fallback paragraph: merge consecutive lines
    const para = [];
    while(i < lines.length && !isBlank(lines[i]) && !isTableRow(lines[i]) && !isSeparatorLine(lines[i]) && !/^\s*#{1,6}\s+/.test(lines[i])){
      if(i+1 < lines.length && lines[i+1].trim() === "") { para.push(lines[i].trim()); i++; break; }
      if(lines[i+1] && (lines[i+1].trim() === lines[i+1].trim().toUpperCase() && lines[i+1].trim().length < 80) ) { para.push(lines[i].trim()); i++; break; }
      para.push(lines[i].trim());
      i++;
    }
    out.push(para.join(" "));
    out.push("");
  }

  return out.join("\n").replace(/\n{3,}/g,"\n\n").trim();
}

/* ---------- Buttons & interactions ---------- */

// Auto-paste: read clipboard text into editor
document.getElementById('btnAutoPaste').addEventListener('click', async ()=>{
  try {
    const text = await navigator.clipboard.readText();
    if(!text) { alert("Clipboard empty or contains non-text."); return; }
    easyMDE.value(text);
    renderPreview(text);
    easyMDE.codemirror.focus();
  } catch(err){
    console.error(err);
    alert("Could not read clipboard. Ensure permission and secure context (https). You can paste manually or upload a .txt file.");
  }
});

// File upload (.txt)
document.getElementById('fileTxt').addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  try {
    const txt = await f.text();
    easyMDE.value(txt);
    renderPreview(txt);
  } catch(err){
    console.error(err);
    alert("Failed to read file: " + err);
  }
});

// Smart Suggest - convert plain text to markdown
document.getElementById('btnSuggest').addEventListener('click', ()=>{
  const raw = easyMDE.value();
  if(!raw || !raw.trim()){ alert("Editor is empty. Paste or upload text first."); return; }
  const md = smartSuggestTransform(raw);
  easyMDE.value(md);
  renderPreview(md);
  easyMDE.codemirror.focus();
});

// Reset
document.getElementById('btnReset').addEventListener('click', ()=>{
  if(!confirm("Clear editor and preview?")) return;
  easyMDE.value("");
  renderPreview("");
});

// Download .md
document.getElementById('btnDownloadMD').addEventListener('click', ()=>{
  const md = easyMDE.value() || "";
  const blob = new Blob([md], {type: "text/markdown;charset=utf-8"});
  saveAs(blob, "document.md");
});

// Copy Markdown to clipboard
document.getElementById('btnCopyMD').addEventListener('click', async ()=>{
  try {
    await navigator.clipboard.writeText(easyMDE.value());
    alert("Markdown copied to clipboard.");
  } catch(err){
    console.error(err);
    alert("Unable to copy to clipboard. Try selecting and copying manually.");
  }
});

/* ---------- PDF export (html2pdf) ---------- */
/* Strategy:
   - Render current markdown into preview (already done)
   - Clone preview into a clean printable container with print-friendly CSS
   - Temporarily remove scrolling and sizing that breaks html2canvas
   - Call html2pdf().set(options).from(container).save()
   - Clean up
*/
function downloadPDF() {
  const filename = prompt("Enter file name:", "my-markdown-file");
  if (!filename) return;

  // Ensure preview HTML is current
  updatePreview(inputText.value);

  // 1. Clone preview into a printable container
  const clone = preview.cloneNode(true);
  clone.classList.add("print-area"); // optional style hook
  clone.style.position = "absolute";
  clone.style.left = "-9999px";
  clone.style.top = "0";
  clone.style.maxHeight = "none";
  clone.style.overflow = "visible";
  clone.style.width = "800px"; // A4 width approx at 96dpi
  clone.style.padding = "20px";
  clone.style.background = "#fff";

  document.body.appendChild(clone);

  // 2. Wait for images (if any) to load
  const images = clone.querySelectorAll("img");
  const waitImages = Promise.all(
    Array.from(images).map(img => {
      return new Promise(res => {
        if (img.complete) res();
        else img.onload = img.onerror = res;
      });
    })
  );

  waitImages.then(() => {
    // 3. Generate PDF
    const opt = {
      margin: 10,
      filename: filename + ".pdf",
      image: { type: "jpeg", quality: 0.98 },
      html2canvas: {
        scale: 2,
        useCORS: true,
        logging: false
      },
      jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
    };

    html2pdf()
      .from(clone)
      .set(opt)
      .save()
      .then(() => {
        // 4. Cleanup
        document.body.removeChild(clone);
      })
      .catch(err => {
        console.error(err);
        document.body.removeChild(clone);
        alert("PDF generation failed.");
      });
  });
}
</script>
</body>
  </html>
